# github-webhook-dispatcher

[English Version](README.md)

[![Build Status](https://img.shields.io/badge/build-passing-brightgreen)](https://github.com/shanth1/gitrelay)
[![Go Report Card](https://goreportcard.com/badge/github.com/shanth1/gitrelay)](https://goreportcard.com/report/github.com/shanth1/gitrelay)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Гибкий сервис на Go для получения вебхуков от GitHub и их отправки в виде форматированных уведомлений в различные каналы, такие как Telegram и Email.

## Обзор

`github-webhook-dispatcher` (также известный как `gitrelay`) — это легковесный, настраиваемый сервер, который работает как мост между вашими репозиториями на GitHub и каналами уведомлений. Он принимает события вебхуков от GitHub, проверяет их подлинность, форматирует в человекочитаемые сообщения с помощью Go-шаблонов и рассылает их по заранее настроенному списку получателей через различные сервисы (например, Telegram, SMTP Email).

Это позволяет создать централизованную систему уведомлений для вашей команды, чтобы все были в курсе активностей в репозиториях: пушей, pull-запросов, новых issue и многого другого.

## Возможности

- **Безопасная обработка вебхуков**: Проверяет входящие вебхуки с помощью заголовка `X-Hub-Signature-256`, чтобы убедиться, что они отправлены именно с GitHub.
- **Многоканальные уведомления**: Поддержка **Telegram** и **Email (SMTP)** «из коробки». Архитектура позволяет легко добавлять новые сервисы.
- **Настраиваемые шаблоны сообщений**: Использует Go `html/template` для форматирования уведомлений. Предоставляются шаблоны для популярных событий (`push`, `issues`, `pull_request` и т.д.), которые легко можно изменить.
- **Гибкая маршрутизация**: Настраивайте несколько «отправителей» (например, разные Telegram-боты или email-аккаунты) и направляйте уведомления различным «получателям» с полным контролем.
- **Конфигурация в формате YAML**: Все настройки, включая адрес сервера, секретный ключ, отправителей и получателей, управляются через один простой для чтения YAML-файл.
- **Корректное завершение работы**: Сервер обрабатывает сигналы `SIGINT`/`SIGTERM` для чистого и безопасного выключения.
- **Две версии**:
  - `gitrelay`: Полноценное, богатое функциями приложение, использующее YAML-конфигурацию.
  - `basic-webhook-handler`: Минималистичный пример, демонстрирующий базовую логику обработки вебхуков с жестко заданными значениями.

## Требования

- [Go](https://golang.org/dl/) (рекомендуется версия 1.18 или выше)
- [Make](https://www.gnu.org/software/make/) для использования удобных команд.
- (Опционально) [golangci-lint](https://golangci-lint.run/usage/install/) для линтинга кода.

## Начало работы

### 1. Клонируйте репозиторий

```bash
git clone https://github.com/your-username/github-webhook-dispatcher.git
cd github-webhook-dispatcher
```

### 2. Установите зависимости

Проект использует Go Modules. Загрузите и проверьте зависимости:

```bash
go mod tidy
```

Или с помощью Makefile:

```bash
make tidy
```

### 3. Соберите приложение

`Makefile` предоставляет удобные команды для сборки. Исполняемые файлы будут помещены в директорию `build/`.

- **Собрать оба приложения (действие по умолчанию):**
  ```bash
  make
  ```
- **Собрать только полную версию (`gitrelay`):**
  ```bash
  make build-complete
  ```
- **Собрать только базовую версию (`basic-webhook-handler`):**
  ```bash
  make build-basic
  ```

## Конфигурация

Основное приложение (`gitrelay`) настраивается с помощью YAML-файла. Шаблон находится по пути `config/example.yaml`.

1.  **Скопируйте пример конфигурации:**

    ```bash
    cp config/example.yaml config/production.yaml
    ```

2.  **Отредактируйте `config/production.yaml`:**

    ```yaml
    # Адрес и порт, который будет слушать сервер.
    addr: ':8080'

    # Секретный ключ для проверки вебхуков от GitHub.
    # Он ДОЛЖЕН совпадать с секретом, который вы укажете в настройках вебхука на GitHub.
    webhook_secret: 'your-super-secret-webhook-string'

    # "Отправители" (senders) определяют, "как" и "откуда" отправлять уведомления.
    senders:
      - name: 'project-telegram-bot' # Уникальное имя для этого отправителя
        type: 'telegram'
        settings:
          token: 'YOUR_TELEGRAM_BOT_TOKEN_1'

      - name: 'smtp-notifications'
        type: 'email'
        settings:
          host: 'smtp.example.com'
          port: 587
          username: 'user@example.com'
          password: 'your-smtp-password'
          from: 'GitHub Notifier <no-reply@example.com>'

    # "Получатели" (recipients) определяют, "кто" получит уведомления.
    recipients:
      - name: 'Dev Team Channel (Telegram)'
        sender: 'project-telegram-bot' # Должно совпадать с именем отправителя выше
        target: '-100123456789' # ID чата/канала в Telegram

      - name: 'Project Lead (Email)'
        sender: 'smtp-notifications'
        target: 'lead@example.com' # Адрес электронной почты
    ```

### Детали конфигурации

- `webhook_secret`: Ключевая настройка безопасности. Эта строка должна быть случайной и сложной.
- `senders`: Список сервисов для отправки уведомлений.
  - `name`: Уникальный идентификатор, который вы будете использовать для связи получателей с этим отправителем.
  - `type`: Может быть `telegram` или `email`.
  - `settings`: Набор пар ключ-значение, специфичных для типа отправителя.
- `recipients`: Список адресатов уведомлений.
  - `sender`: `name` отправителя, который будет использован для этого получателя.
  - `target`: Идентификатор получателя (например, ID чата в Telegram или email-адрес).

## Запуск приложения

### 1. Запуск полной версии (`gitrelay`)

Передайте путь к вашему файлу конфигурации через флаг `--config`.

```bash
./build/gitrelay --config config/production.yaml
```

Вы также можете использовать команду `make`, которая запускает приложение с файлом `config/example.yaml`:

```bash
make run
```

Сервер запустится и выведет сообщение в лог: `{"level":"info","service":"telehook","time":"...","message":"staring server on :8080"}`.

### 2. Настройка вебхука на GitHub

1.  Перейдите в ваш репозиторий на GitHub.
2.  Откройте **Settings** > **Webhooks**.
3.  Нажмите **Add webhook**.
4.  **Payload URL**: Введите публичный URL, по которому доступно ваше приложение (например, `http://your-server-ip:8080/webhook`). Для локального тестирования может понадобиться инструмент вроде [ngrok](https://ngrok.com/).
5.  **Content type**: Выберите `application/json`.
6.  **Secret**: Введите ту же самую строку, что и в `webhook_secret` в вашем файле конфигурации.
7.  **Which events would you like to trigger this webhook?**: Выберите события, которые вас интересуют (например, "Pushes", "Issues", "Pull requests").
8.  Нажмите **Add webhook**.

GitHub отправит событие `ping` на ваш сервер, чтобы проверить соединение.

## Тестирование

Проект включает в себя скрипт для тестирования (`webhook.sh`) и стандартные тесты Go.

### Запуск юнит-тестов Go

Чтобы запустить все юнит-тесты проекта:

```bash
make test
```

### Симуляция вебхуков от GitHub

Скрипт `webhook.sh` может симулировать отправку различных событий вебхуков на локально запущенный сервер. Это очень полезно для проверки конфигурации и шаблонов сообщений без необходимости выполнять действия на GitHub.

**Важно**: Убедитесь, что `WEBHOOK_SECRET` внутри `webhook.sh` совпадает с `webhook_secret` в вашем YAML-конфиге.

- **Отправить все поддерживаемые тестовые события:**
  (Сначала убедитесь, что сервер `gitrelay` запущен в другом терминале)

  ```bash
  make test-webhook
  ```

- **Отправить конкретное событие (например, `push`):**

  ```bash
  make test-webhook EVENT=push
  ```

- **Также доступны удобные сокращения:**
  ```bash
  make test-push
  make test-ping
  make test-issues
  ```

## Команды Makefile

`Makefile` предоставляет несколько полезных команд для разработки и обслуживания.

| Команда             | Описание                                                           |
| ------------------- | ------------------------------------------------------------------ |
| `make all` / `make` | Собрать оба приложения (полное и базовое) (действие по умолчанию). |
| `make build`        | Псевдоним для `make all`.                                          |
| `make build-all`    | Явно собирает оба бинарных файла.                                  |
| `make run`          | Собрать и запустить основное приложение с `config/example.yaml`.   |
| `make run-basic`    | Собрать и запустить базовое приложение.                            |
| `make test`         | Запустить все юнит-тесты Go.                                       |
| `make test-webhook` | Отправить все тестовые вебхуки с помощью `webhook.sh`.             |
| `make test-push`    | Отправить тестовое событие `push`.                                 |
| `make clean`        | Удалить директорию `build/` и все скомпилированные файлы.          |
| `make tidy`         | Выполнить `go mod tidy`.                                           |
| `make fmt`          | Отформатировать все исходные файлы Go с помощью `go fmt`.          |
| `make vet`          | Запустить `go vet` для проверки кода на наличие типичных проблем.  |
| `make lint`         | Запустить линтер `golangci-lint` (если он установлен).             |

## Структура проекта

```
.
├── build/                 # Скомпилированные бинарные файлы (создаются через make)
├── cmd/
│   ├── basic/             # Исходный код для простого обработчика вебхуков
│   └── complete/          # Исходный код для основного настраиваемого приложения (gitrelay)
├── config/
│   └── example.yaml       # Пример файла конфигурации
├── internal/              # Внутренние пакеты Go для основного приложения
│   ├── app/               # Настройка приложения и жизненный цикл сервера
│   ├── config/            # Структуры для конфигурации
│   ├── handler/           # HTTP-обработчики для вебхуков
│   ├── service/           # Сервисы уведомлений (Telegram, Email и т.д.)
│   └── templates/         # Логика загрузки Go-шаблонов
├── templates/             # Go-шаблоны для форматирования уведомлений
│   ├── *.tmpl             # Файлы шаблонов для конкретных событий GitHub
│   └── embed.go           # Встраивает шаблоны в бинарный файл
├── Makefile               # Команды для сборки, запуска и тестирования
├── go.mod                 # Определения Go-модуля
└── webhook.sh             # Скрипт для отправки тестовых вебхуков
```

## Участие в разработке

Pull request'ы приветствуются. Для крупных изменений, пожалуйста, сначала создайте issue, чтобы обсудить, что вы хотели бы изменить. Пожалуйста, не забудьте обновить тесты при необходимости.

## Лицензия

Проект распространяется под [лицензией MIT](LICENSE).
